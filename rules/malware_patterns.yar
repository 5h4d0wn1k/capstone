rule suspicious_powershell {
    meta:
        description = "Detects suspicious PowerShell command patterns"
        author = "SIEM Team"
        severity = "High"
        created = "2023-10-15"
    
    strings:
        $encoded_cmd = /powershell.*enc.*[A-Za-z0-9+\/]{20,}/ nocase
        $download = /Invoke-WebRequest|wget|curl|DownloadString/ nocase
        $exec = /Invoke-Expression|iex|Invoke-Command/ nocase
        $bypass = /bypass|ExecutionPolicy/ nocase
        $hidden = /-w hidden|-windowstyle hidden/ nocase
        
    condition:
        $encoded_cmd or
        ($download and $exec) or
        ($bypass and $hidden)
}

rule ransomware_behavior {
    meta:
        description = "Detects potential ransomware behavior"
        author = "SIEM Team"
        severity = "Critical"
        created = "2023-10-15"
    
    strings:
        $encrypt_ext = /\.encrypted$|\.locked$|\.crypted$|\.crypt$/ nocase
        $ransom_note = /HELP_DECRYPT|YOUR_FILES|DECRYPT_INSTRUCTION|HOW_TO_DECRYPT/ nocase
        $delete_shadows = /vssadmin delete shadows/ nocase
        $stop_services = /net stop|sc stop/ nocase
        
    condition:
        $encrypt_ext or
        $ransom_note or
        ($delete_shadows and $stop_services)
}

rule data_exfiltration {
    meta:
        description = "Detects potential data exfiltration attempts"
        author = "SIEM Team"
        severity = "High"
        created = "2023-10-15"
    
    strings:
        $compress = /\.zip$|\.rar$|\.7z$|\.tar\.gz$/ nocase
        $sensitive = /password|creditcard|ssn|social.*security/ nocase
        $upload = /upload|put|post|transfer/ nocase
        $unusual_dest = /pastebin\.com|transfer\.sh|mega\.nz/ nocase
        
    condition:
        ($compress and $sensitive) or
        ($upload and $unusual_dest)
}

rule webshell_detection {
    meta:
        description = "Detects common web shell patterns"
        author = "SIEM Team"
        severity = "Critical"
        created = "2023-10-15"
    
    strings:
        $php_shell = "<?php" nocase
        $asp_shell = "<%@" nocase
        $suspicious_func = /eval|exec|system|shell_exec|passthru/ nocase
        $base64_decode = /base64_decode|frombase64string/ nocase
        $file_ops = /fopen|file_get_contents|file_put_contents/ nocase
        $cmd_exec = /cmd\.exe|\/bin\/bash|\/bin\/sh/ nocase
        
    condition:
        ($php_shell or $asp_shell) and
        ($suspicious_func or $base64_decode) and
        ($file_ops or $cmd_exec)
}

rule credential_theft {
    meta:
        description = "Detects potential credential theft attempts"
        author = "SIEM Team"
        severity = "High"
        created = "2023-10-15"
    
    strings:
        $mimikatz = /mimikatz|sekurlsa::logonpasswords|wdigest/ nocase
        $dump = /lsass\.exe|lsass\.dmp/ nocase
        $registry = /SAM|SECURITY|SYSTEM/ nocase
        $credential_files = /\.pfx$|\.p12$|\.key$|\.kdb$/ nocase
        
    condition:
        $mimikatz or
        ($dump and $registry) or
        $credential_files
}

rule lateral_movement {
    meta:
        description = "Detects potential lateral movement attempts"
        author = "SIEM Team"
        severity = "High"
        created = "2023-10-15"
    
    strings:
        $psexec = /psexec|paexec|csexec/ nocase
        $wmi = /wmic.*process call create|win32_process|wmiprvse/ nocase
        $rdp = /tscon|mstsc|rdpclip/ nocase
        $admin_shares = /\\\\.*\\admin\$|\\\\.*\\c\$/ nocase
        
    condition:
        $psexec or
        $wmi or
        $rdp or
        $admin_shares
}

rule persistence_mechanism {
    meta:
        description = "Detects common persistence mechanisms"
        author = "SIEM Team"
        severity = "High"
        created = "2023-10-15"
    
    strings:
        $startup = /\\Startup\\|\\Microsoft\\Windows\\Start Menu\\Programs\\Startup/ nocase
        $registry_run = /\\Software\\Microsoft\\Windows\\CurrentVersion\\Run/ nocase
        $scheduled_task = /schtasks|at \d{2}:\d{2}/ nocase
        $service_create = /sc create|New-Service/ nocase
        
    condition:
        $startup or
        $registry_run or
        $scheduled_task or
        $service_create
}

rule command_control {
    meta:
        description = "Detects potential command and control activity"
        author = "SIEM Team"
        severity = "Critical"
        created = "2023-10-15"
    
    strings:
        $dns_tunnel = /\.tk$|\.pw$|\.top$|\.cc$/ nocase
        $beaconing = /sleep|ping -n|timeout|waitfor/ nocase
        $encoded_traffic = /base64|hex|rot13|xor/ nocase
        $unusual_port = /:444|:2222|:8888|:9999/ nocase
        
    condition:
        $dns_tunnel or
        ($beaconing and $encoded_traffic) or
        $unusual_port
}

rule defense_evasion {
    meta:
        description = "Detects defense evasion techniques"
        author = "SIEM Team"
        severity = "High"
        created = "2023-10-15"
    
    strings:
        $disable_security = /Disable-WindowsDefender|Set-MpPreference/ nocase
        $clear_logs = /wevtutil cl|Clear-EventLog/ nocase
        $timestomp = /touch -r|SetFileTime/ nocase
        $delete_restore = /wbadmin delete systemstatebackup/ nocase
        
    condition:
        $disable_security or
        $clear_logs or
        $timestomp or
        $delete_restore
}
